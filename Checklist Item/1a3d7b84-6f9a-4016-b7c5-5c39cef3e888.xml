<?xml version="1.0"?>
<TeamMentor_Article Metadata_Hash="-1346184630" Content_Hash="-1729306861">
  <Metadata>
    <Id>1a3d7b84-6f9a-4016-b7c5-5c39cef3e888</Id>
    <Id_History>1a3d7b84-6f9a-4016-b7c5-5c39cef3e888,4ba77441-3f79-4ce5-930d-268b841cafcf,</Id_History>
    <Library_Id>92718d53-36b2-47bc-b6f5-e60994385f46</Library_Id>
    <Title>SuppressUnmanagedCode Is Used with Caution</Title>
    <Category>Unmanaged Code</Category>
    <Phase>Implementation</Phase>
    <Technology>.NET 3.5</Technology>
    <Type>Checklist Item</Type>
    <DirectLink>SuppressUnmanagedCode Is Used with Caution</DirectLink>
    <Tag />
    <Security_Demand />
    <Author />
    <Priority />
    <Status />
    <Source>SI</Source>
  </Metadata>
  <Content Sanitized="true" DataType="Html">
    <Data><![CDATA[<h1>What to Check For</h1>
  <p>Check to ensure that the SuppressUnmanagedCode attribute is used only if assembly takes precautions to ensure that malicious code cannot coerce it into performing unwanted operations.</p>
  <p />
  <h1>How to Fix</h1>
  <p>If your assembly makes many calls to unmanaged code, the performance overhead associated with multiple unmanaged code permission demands can become an issue.</p>
  <p>In this situation, you can use the <b>SupressUnmanagedCodeSecurity</b> attribute on the P/Invoke method declaration. This causes the full demand for the unmanaged permission to be replaced with a link demand which only occurs once at just-in-time (JIT) compilation time.</p>
  <p>Link demands make your code vulnerable to luring attacks. To mitigate the risk, you should suppress the unmanaged code permission demand only if your assembly takes adequate precautions to ensure that it cannot be coerced by malicious code to perform unwanted operations. An example of a suitable countermeasure is if your assembly demands a custom permission that more closely reflects the operation being performed by the unmanaged code</p>
  <h3>Using SuppressUnmanagedCodeSecurity with P/Invoke</h3>
  <p>The following code shows how to apply the <b>SuppressUnmanagedCodeSecurity</b> attribute to a P/Invoke method declaration.</p>
  <div>
    <pre>public NativeMethods&amp;#123;<br />  // The use of SuppressUnmanagedCodeSecurity here applies only to FormatMessage<br />  &amp;#91;DllImport("kernel32.dll"), SuppressUnmanagedCodeSecurity&amp;#93;<br />  private unsafe static extern int FormatMessage(<br />                                      int dwFlags,<br />                                       ref IntPtr lpSource,<br />                                       int dwMessageId,<br />                                      int dwLanguageId,<br />                                       ref String lpBuffer, int nSize,<br />                                       IntPtr &amp;#42;Arguments);<br />&amp;#125;  </pre>
  </div>
  <h3>Using SuppressUnmanagedCodeSecurity with COM Interop</h3>
  <p>For COM interop calls, the attribute must be used at the interface level, as shown in the following example.</p>
  <div>
    <pre> &amp;#91;SuppressUnmanagedCodeSecurity&amp;#93;<br />public interface IComInterface&amp;#123;&amp;#125;</pre>
  </div>
  <hr />
  <p>Adapted from Microsoft patterns &amp; practices guidance.</p>]]></Data>
  </Content>
</TeamMentor_Article>