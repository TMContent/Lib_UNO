<?xml version="1.0"?>
<TeamMentor_Article Metadata_Hash="1378238194" Content_Hash="-1975562227">
  <Metadata>
    <Id>55136114-e1e3-465c-b648-55a7d1fe3f19</Id>
    <Id_History>e39747de-b815-4da5-93d0-624ddccce3c3,</Id_History>
    <Library_Id>be5273b1-d682-4361-99d9-6234f2d47eb7</Library_Id>
    <Title>How to Test for ARP Poisoning Bugs</Title>
    <Category>Testing</Category>
    <Phase>Test</Phase>
    <Technology>Web Application</Technology>
    <Type>How To</Type>
    <DirectLink>How to Test for ARP Poisoning Bugs</DirectLink>
    <Tag />
    <Security_Demand />
    <Author />
    <Priority>Andres De Vivanco</Priority>
    <Status />
    <Source>SI</Source>
  </Metadata>
  <Content Sanitized="true" DataType="Html">
    <Data><![CDATA[<h1>
    <span>Applies to:</span>
  </h1>
  <ul>
    <li>
      <span>PCs, workstations, and servers in switched Ethernet and wireless networks.</span>
    </li>
  </ul>
  <p>
    <span>&amp;nbsp;</span>
  </p>
  <h1>
    <span>Summary</span>
  </h1>
  <p>
    <span>ARP (Address Resolution Protocol) enables any computer to query the MAC address of an IP so that packets can reach their final physical destination.<span>&amp;nbsp;&amp;nbsp; </span>When a node wants to communicate with certain IP it checks it has the MAC address for that IP in its APR cache.<span>&amp;nbsp; </span>If the node doesn’t have the MAC it broadcasts an ARP request.<span>&amp;nbsp; </span>When the destination IP receives the ARP request it sends and ARP reply back to the node containing its MAC address.<span>&amp;nbsp; </span><span>&amp;nbsp;</span>After receiving the ARP reply, the node updates its ARP cache and associates the MAC address with the destination IP.</span>
  </p>
  <p>
    <span>During ARP poisoning, also known as ARP spoofing or ARP cache poisoning, the attacker sends ARP replies to a victim node to poison the victim’s ARP cache.<span>&amp;nbsp; </span>Since the ARP protocol is stateless, the attacker can trivially modify the ARP cache and replace a legitimate MAC address with the attacker MAC address for any target IP in the victim’s cache.<span>&amp;nbsp;&amp;nbsp; </span>A successful ARP poisoning attack leads to a Man-in-the Middle conditions since any network traffic form the victim node to the target IP will go through the attacker first.</span>
  </p>
  <p>
    <span>Follow the next steps to test for ARP poisoning bugs:</span>
  </p>
  <ul>
    <li>
      <span>Step 1:<span>&amp;nbsp; </span>Understand Attack Scenarios</span>
      <li>
        <span>Step 2:<span>&amp;nbsp; </span>Analyze Causes and Countermeasures</span>
        <li>
          <span>Step 3:<span>&amp;nbsp; </span>Start Testing and Exploring</span>
          <li>
            <span>Step 4:<span>&amp;nbsp; </span>Perform Additional Testing</span>
          </li>
        </li>
      </li>
    </li>
  </ul>
  <p>
    <span>&amp;nbsp;</span>
  </p>
  <h1>
    <span>Step 1:<span>&amp;nbsp; </span>Understand Attack Scenarios</span>
  </h1>
  <p>
    <span>The first step in testing ARP poisoning attacks is to understand the basic attack scenarios.<span>&amp;nbsp; </span>The following are common ARP poisoning scenarios:</span>
  </p>
  <ul>
    <li>
      <span>ARP poisoning to sniff network traffic</span>
      <li>
        <span>ARP poisoning to execute phishing attack</span>
      </li>
    </li>
  </ul>
  <p>
    <span>&amp;nbsp;</span>
  </p>
  <h2>
    <span>
      <em>ARP poisoning to Sniff Network Traffic</em>
    </span>
  </h2>
  <p>
    <span>The most common ARP poisoning scenario targets disclosing information by means of sniffing a network communication.<span>&amp;nbsp; </span>An attacker selects two victims (A and B) to execute the eavesdropping attack.<span>&amp;nbsp;&amp;nbsp; </span>It then sends ARP replies to victim A indicating that the MAC for B’s IP is the attacker’s MAC and ARP replies to victim B indicating that the MAC for A’s IP is the attacker’s MAC.<span>&amp;nbsp; </span>The attacker then sets IP forwarding so that packets are forward from A to B.<span>&amp;nbsp; </span>Finally, the attacker uses a network monitoring tool to view the contents of the packets being exchanged from A to B.</span>
  </p>
  <p>
    <span>In detail:</span>
  </p>
  <ol>
    <li>
      <span>Attacker selects victim nodes.<span>&amp;nbsp;&amp;nbsp; </span>In many cases the attacker selects the gateway as one of the victims to sniff all traffic between the other victim and the Internet.</span>
      <li>
        <span>Attacker sends ARP replies to victim to poison its cache.</span>
        <li>
          <span>Attacker sets IP packet forwarding in his box.</span>
          <li>
            <span>Attacker waits until ARP caches are poison and starts monitoring the traffic using a network monitoring tool.</span>
          </li>
        </li>
      </li>
    </li>
  </ol>
  <p>
    <span>&amp;nbsp;</span>
  </p>
  <h2>
    <span>
      <em>ARP poisoning to Execute Phishing Attack</em>
    </span>
  </h2>
  <p>
    <span>Another dangerous application of ARP poisoning consists of executing a phishing attack on a network node.<span>&amp;nbsp; </span>For example, the attacker poisons a victim’s ARP cache so that when the victim visits its online banking site it receives a phished version of the banking site entirely controlled by the attacker instead of the original site.<span>&amp;nbsp;&amp;nbsp; </span>In a switched network this is done by tunneling all DNS responses from the gateway to the victim through the attacker.<span>&amp;nbsp;&amp;nbsp; </span>Upon receiving the DNS responses for the bank, the gateway will forward them to the attacker who can modify them at his own will and change the original bank’s IP with an IP corresponding to a phishing site.</span>
  </p>
  <p>
    <span>In detail:</span>
  </p>
  <ol>
    <li>
      <span>Attacker selects victim.<span>&amp;nbsp; </span></span>
      <li>
        <span>Attacker sends ARP replies to the victim and the gateway to tell the victim that the MAC of the gateway is the attacker’s MAC, and to tell the gateway that the MAC of the victim is the attacker’s MAC.</span>
        <li>
          <span>Attacker waits until ARP caches of the gateway and victim are poisoned.</span>
          <li>
            <span>Attacker sets an event to intercept the traffic that comes from the target IP (in the example an online bank).</span>
            <li>
              <span>Victim client makes a DNS request to the target IP (through the gateway).</span>
              <li>
                <span>Gateway forwards the DNS request and receives a response from the DNS server to resolve the target IP.</span>
                <li>
                  <span>Gateway forwards the DNS response to the attacker’s MAC.<span>&amp;nbsp; </span></span>
                  <li>
                    <span>Attacker modifies the DNS response by changing the original target IP with a phishing IP.</span>
                    <li>
                      <span>Attack forwards modified DNS response to the victim.</span>
                    </li>
                  </li>
                </li>
              </li>
            </li>
          </li>
        </li>
      </li>
    </li>
  </ol>
  <p>
    <span>&amp;nbsp;</span>
  </p>
  <h1>
    <span>Step 2:<span>&amp;nbsp; </span>Analyze Causes and Countermeasures</span>
  </h1>
  <p>
    <span>The next step in testing ARP poisoning bugs is to understand what causes them and how to defend against them.<span>&amp;nbsp;&amp;nbsp; </span>This will tell you what networks are susceptible to this attack and what measures to take to protect against them.</span>
  </p>
  <h2>
    <span>
      <em>ARP Poisoning Causes</em>
    </span>
  </h2>
  <p>
    <span>Switched Local Area Networks (LANs) are networks that utilize switches instead of hubs.<span>&amp;nbsp;&amp;nbsp; </span>Switches are more secure than hubs because they deliver packets to specific nodes rather than acting as broadcasters.<span>&amp;nbsp; </span>As opposed to hub networks, a network node sniffing packets in promiscuous mode will not be able to monitor the traffic between another two nodes in a switched network.<span>&amp;nbsp; </span>ARP Poisoning attacks are specific to switched networks and exist by default.<span>&amp;nbsp; </span>Switched networks work by sending ARP requests and receiving ARP replies.<span>&amp;nbsp;&amp;nbsp; </span>The problem and root cause of this bug is that this protocol is stateless.<span>&amp;nbsp; </span>A network node doesn’t check that an ARP reply actually comes as a reply from a legitimate ARP request.<span>&amp;nbsp; </span>It just assumes that all ARP requests are legitimate giving room to ARP poisoning attacks.<span>&amp;nbsp;&amp;nbsp; </span></span>
  </p>
  <p>
    <span>&amp;nbsp;</span>
  </p>
  <h2>
    <span>
      <em>ARP Poisoning Countermeasures</em>
    </span>
  </h2>
  <p>
    <span>ARP poisoning can’t be totally prevented but can be mitigated.<span>&amp;nbsp; </span>A way of doing this is to have static ARP tables so that any changes in the ARP tables are disallowed.<span>&amp;nbsp;&amp;nbsp; </span>However, this is impractical in large or rapidly changing networks [i].<span>&amp;nbsp; </span>A more reliable countermeasure consists of proactively denying ARP packets in a switched network.<span>&amp;nbsp;&amp;nbsp; </span>This method known as DHCP Snooping’s ARP Security, or Dynamic ARP Inspection, enforces a network policy that disallows any ARP packets to be forwarded if the source IP (Source Protocol Address field) is not genuine.</span>
  </p>
  <p>
    <span>Additional ARP poisoning detection and prevention tools are available in the Internet.<span>&amp;nbsp;&amp;nbsp;&amp;nbsp; </span>For instance, Unix-based Arpwatch sends an email notification as soon as an ARP cache entry changes or Windows-based XArp also offers configuration options to intercept any malicious ARP packets.<span>&amp;nbsp; </span>Finally, it is also possible to configure Network Intrusion Detection Systems (NIDS) to add rules to protect against ARP spoofing attacks.</span>
  </p>
  <p>
    <span>&amp;nbsp;</span>
  </p>
  <h1>
    <span>Step 3:<span>&amp;nbsp; </span>Start Testing and Exploring</span>
  </h1>
  <p>
    <span>Now that you’ve learned ARP Poisoning attack scenarios, why are they caused, and how to defend against them, this guides on how to execute ARP poisoning basic test cases.</span>
  </p>
  <p>
    <b>
      <i>
        <span>&amp;nbsp;</span>
      </i>
    </b>
  </p>
  <h2>
    <span>
      <em>Test for ARP Poisoning to Sniff Network Traffic</em>
    </span>
  </h2>
  <p>
    <span>To test for ARP poisoning for network sniffing you will need two boxes (a victim and an attacker) in the same network and a gateway box.<span>&amp;nbsp; </span>Follow these steps:</span>
  </p>
  <ol>
    <li>
      <span>Download and install Cain and Wireshark in the attacker’s box.</span>
      <li>
        <span>Run Cain. </span>
        <li>
          <span>Click Configure in the menu and select the network interface (can be wireless interface).</span>
          <li>
            <span>Click on the Sniffer tab and the Hosts sub tab.</span>
            <li>
              <span>Start the sniffer and click the plus (+) sign.</span>
              <li>
                <span>Select a range of IPs to scan their MAC (include the target box in the range) and click OK.<span>&amp;nbsp; </span>Both the gateway and victim IPs (and their MACs) should appear in the hosts list.</span>
                <li>
                  <span>Click the ARP poisoning sub tab.</span>
                  <li>
                    <span>Click on the plus sign and add an ARP route from the victim to the gateway.</span>
                    <li>
                      <span>Start ARP by pressing the ARP button.<span>&amp;nbsp; </span>As soon as the victim becomes active its status changes from “idle” to “poisoning”.<span>&amp;nbsp; </span>The lower pane starts showing the packets being intercepted (see Figure 1).</span>
                      <li>
                        <span>Start Wireshark and start capturing network traffic in the same interface selected in Cain.</span>
                      </li>
                    </li>
                  </li>
                </li>
              </li>
            </li>
          </li>
        </li>
      </li>
    </li>
  </ol>
  <p>
    <span>Expected results:</span>
  </p>
  <p>
    <span>The first check you can to see if the ARP attack was successful do is running the <i>arp -a</i> command in the victim box (or its Unix equivalent).<span>&amp;nbsp; </span>After executing the attack the entry for the gateway must be different.<span>&amp;nbsp; </span>For instance, in windows running <i>arp -a </i>before the attack gives this:</span>
  </p>
  <pre>
    <span>C:\&gt;arp -a</span>
  </pre>
  <pre>
    <span>Interface: 192.168.1.33 --- 0x8<br />&amp;nbsp; Internet Address&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; IP Address&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Type<br />&amp;nbsp; 192.168.1.1&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; 00-13-49-5c-e3-de&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; dynamic<br />&amp;nbsp; 192.168.1.255&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; ff-ff-ff-ff-ff-ff&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; static<br />&amp;nbsp; 224.0.0.22&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; 01-00-5e-00-00-16&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; static</span>
  </pre>
  <p>
    <span>
    </span>
  </p>
  <p>
    <span>After the attack the gateway entry in the victim’s ARP cache must be different (it is now equal to the attacker’s MAC):</span>
  </p>
  <pre>
    <span>C:\&gt;arp -a<br />&amp;nbsp;<br />Interface: 192.168.1.33 --- 0x8<br />&amp;nbsp; Internet Address&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; IP Address&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Type<br />&amp;nbsp; 192.168.1.1&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; <strong>00-1b-77-b2-73-f2</strong>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; dynamic<br />&amp;nbsp; 192.168.1.255&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; ff-ff-ff-ff-ff-ff&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; static<br />&amp;nbsp; 224.0.0.22&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; 01-00-5e-00-00-16&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; static<br /></span>
  </pre>
  <p>
    <span>
    </span>
  </p>
  <p>
    <span>A successful ARP poisoning attack will be visible both in Cain and Wireshark.<span>&amp;nbsp; </span>In Cain, the lower pain of the Sniffer-&gt;ARP tab shows the packets being sniffer.<span>&amp;nbsp; </span>You can use Wireshark to see the actual contents of the packets (see Figure 2).</span>
  </p>
  <p>
    <span>
      <img src="|image|clip_image001.png" />
    </span>
    <b>
      <span>
        <span>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; </span>
      </span>
    </b>
  </p>
  <p>
    <b>
      <span>
        <span>
        </span>Figure 1 - Using Cain to ARP poison a connection between a victim and a gateway</span>
    </b>
  </p>
  <p>
    <b>
      <span>&amp;nbsp;</span>
    </b>
  </p>
  <p>
    <span>
      <img src="|image|clip_image003.png" />
    </span>
  </p>
  <p>
    <span>
    </span>
    <span>
      <span>&amp;nbsp;&amp;nbsp; </span>
    </span>
    <b>
      <span>Figure 2 - Using Wireshark to read the contents of the sniffed packets</span>
    </b>
  </p>
  <p>
    <b>
      <span>
      </span>
    </b>&amp;nbsp;</p>
  <p>
    <b>
      <i>
        <span>
        </span>
      </i>
    </b>
  </p>
  <h2>
    <span>
      <em>Test for ARP Poisoning to Execute Phishing Attack<span>s</span></em>
    </span>
  </h2>
  <p>
    <span>To test for phishing of a network node we will use Cain’s ARP-DNS feature.<span>&amp;nbsp; </span>The ARP-DNS feature does more than just sniffing network packets.<span>&amp;nbsp; </span>It modifies the contents of any DNS reply to the victim and replaces the IP of the target DNS domain with the attacker’s IP.<span>&amp;nbsp; </span><span>&amp;nbsp;</span>Follow these steps to execute the test case:</span>
  </p>
  <ol>
    <li>
      <span>Repeat steps 1 to 8 from previous test case (installing Wireshark is optional).</span>
      <li>
        <span>In Cain, click on the Sniffer-&gt;ARP tab and select ARP-DNS.</span>
        <li>
          <span>Add an entry that redirects <a href="http://www.facebook.com/">www.facebook.com</a> to <a href="http://ha.ckers.org/">ha.ckers.org</a>.</span>
          <li>
            <span>Start ARP by pressing the ARP button.<span>&amp;nbsp; </span>As soon as the victim becomes active its status changes from “idle” to “poisoning”.<span>&amp;nbsp; </span>The lower pane starts showing the packets being intercepted (see Figure 1).</span>
            <li>
              <span>In the victim’s box, open a browser and browse to <a href="http://www.facebook.com/">www.facebook.com</a>.</span>
            </li>
          </li>
        </li>
      </li>
    </li>
  </ol>
  <p>
    <span>Expected results:</span>
  </p>
  <p>
    <span>You can verify if the ARP poisoning was successful by running the arp command as in the previous example.<span>&amp;nbsp; </span>To verify the redirection/defacement check if step 5 takes you to ha.ckers.org as shown in Figure 3.</span>
  </p>
  <p>
    <em>
      <span>
      </span>
    </em>
  </p>
  <p>
    <span>
    </span>
    <b>
      <span>
        <img src="|image|Dibujo4.jpg" />
      </span>
    </b>
  </p>
  <p>
    <b>
      <span>Figure 3 - Effects of an ARP DNS attack</span>
    </b>
  </p>
  <p>
    <b>
      <span>
        <em>
        </em>
      </span>
    </b>&amp;nbsp;</p>
  <h1>
    <span>Step 4:<span>&amp;nbsp; </span>Perform Additional Testing</span>
  </h1>
  <p>
    <span>Now that you’ve executed the basic ARP poisoning test cases, you must consider additional attacks.<span>&amp;nbsp; </span>This step consists of executing test cases such as sniffing an SSL connection and recovering a password by means of an ARP poisoning attack.<span>&amp;nbsp; </span><span>&amp;nbsp;&amp;nbsp;</span>Use tools such as Ettercap or Cain to execute the multiple attack variations of ARP poisoning including:</span>
  </p>
  <ul>
    <li>
      <span>HTTP session sniffing.</span>
      <li>
        <span>Voice over IP (VOIP) sniffing.</span>
        <li>
          <span>Password recovery and password cracking.</span>
          <li>
            <span>Denial of services.</span>
          </li>
        </li>
      </li>
    </li>
  </ul>
  <p>
    <b>
      <span>&amp;nbsp;</span>
    </b>
  </p>
  <h1>
    <span>Conclusions</span>
  </h1>
  <p>
    <span>The problem with ARP poisoning attacks is that, while trivial to execute, they carry a high impact.<span>&amp;nbsp; </span>In addition, operating systems like Windows don’t defend against them by default.<span>&amp;nbsp; </span>It is necessary that you understand the attack scenarios related to ARP poisoning so that you realize the danger of these attacks.<span>&amp;nbsp; </span>Then go over the causes and the countermeasures available.<span>&amp;nbsp; </span>Finally, execute the basic test cases and any additional ones depending on the ARP poisoning attack variations you want. </span>
  </p>
  <div>
    <br />
    <hr />
    <div>
      <p>
        <span>[i]<strong>&amp;nbsp;ARP Spoofing</strong>. Wikipedia. http://en.wikipedia.org/wiki/ARP_spoofing</span>
      </p>
    </div>
  </div>]]></Data>
  </Content>
</TeamMentor_Article>