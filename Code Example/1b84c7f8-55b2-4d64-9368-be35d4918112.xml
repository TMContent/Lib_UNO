<?xml version="1.0"?>
<TeamMentor_Article Metadata_Hash="1163845018" Content_Hash="1742895682">
  <Metadata>
    <Id>1b84c7f8-55b2-4d64-9368-be35d4918112</Id>
    <Id_History>7a3f2cfe-742a-4789-bc4d-a741b892b428,</Id_History>
    <Library_Id>ea854894-8e16-46c8-9c61-737ef46d7e82</Library_Id>
    <Title>Using Stored Procedures for Secure Database Access</Title>
    <Category>Data Access</Category>
    <Phase>Implementation</Phase>
    <Technology>ASP.NET 2.0</Technology>
    <Type>Code Example</Type>
    <DirectLink>Using Stored Procedures for Secure Database Access</DirectLink>
    <Tag />
    <Security_Demand />
    <Author />
    <Priority>J.D. Meier, Jonathan Bailey, Prashant Bansode</Priority>
    <Status />
    <Source>SI</Source>
  </Metadata>
  <Content Sanitized="true" DataType="Html">
    <Data><![CDATA[<h1>Applies To</h1>
  <ul>
    <li>ASP.NET 2.0 </li>
    <li>C# </li>
    <li>Server-side </li>
    <li>SQL Server</li>
  </ul>
  <h1>Summary</h1>
  <p>The purpose of this code snippet is to illustrate the construction of database queries using stored procedures to add additional security to database operations for .NET applications.</p>
  <h1>Objectives</h1>
  <ul>
    <li>Define and fix query logic during implementation of database operations </li>
    <li>Protect against potential SQL injection attacks</li>
  </ul>
  <h1>Scenarios</h1>
  <ul>
    <li>Application database operations can be defined and implemented at compile/deployment time </li>
    <li>Application needs to make use of user input of any form in database queries </li>
    <li>Application needs to make use of output from other database or code operations in database queries</li>
  </ul>
  <h1>Solution Example</h1>
  <pre>static void StoredProcedureDBQuery()<br />{<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; // Create a new database connection using Integrated Security<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; string connectionString = "Initial Catalog=snippets;Data Source=vm-win2003<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; \\sqlexpress;Integrated Security=SSPI;";<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; SqlConnection cn = new SqlConnection(connectionString);</pre>
  <pre>
    <br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; // Create a new SQL Command object with a query to execute the stored procedure<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; SqlCommand sqlCommand = new SqlCommand("exec spFullNames", cn);</pre>
  <pre>
    <br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; // Open connection to the server and execute query, returning a data reader<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; cn.Open();</pre>
  <pre>
    <br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; SqlDataReader reader = sqlCommand.ExecuteReader();<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; while (reader.Read())<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Console.WriteLine("Result: " + reader.GetString(0));</pre>
  <pre>
    <br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; // Close Reader and Connection.<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; reader.Close();<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; cn.Close();</pre>
  <pre>
    <br />}</pre>
  <h1>Problem Example</h1>
  <p>The following example demonstrates the use of string concatenation to dynamically create a database query. </p>
  <pre>string sParam = Request["first_name"];</pre>
  <pre>
    <br />// Create a new database connection using Integrated Security<br />string connectionString = "Initial Catalog=snippets;Data Source=vm-win2003<br />	&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; \\sqlexpress;Integrated Security=SSPI;";<br />SqlConnection cn = new SqlConnection(connectionString);</pre>
  <pre>
    <br />// Create a new SQL Command object with our query<br />// Dynamically generate SQL query using passed parameter<br />SqlCommand sqlCommand = new SqlCommand("SELECT first, last FROM people WHERE first = '" + sParam + "'", cn);</pre>
  <pre>
    <br />// Open connection to the server and execute query, returning a data reader<br />cn.Open();<br />SqlDataReader reader = sqlCommand.ExecuteReader();</pre>
  <pre>
    <br />while (reader.Read())<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Console.WriteLine("Result: " + reader.GetString(0) + " " + reader.GetString(1));</pre>
  <pre>
    <br />// Close Reader and Connection.<br />reader.Close();<br />cn.Close();<br /></pre>
  <ul>
    <li>Code does not first validate the "first_name" CGI data before incorporation into the database query </li>
    <li>SqlCommand object makes use of a dynamically-generated string containing user input, which makes this operations vulnerable to SQL injection. For instance, the following sParam value could result in the deletion of the entire application database from the environment:</li>
  </ul>
  <pre>abcxyz'; drop database snippets; -- </pre>
  <ul>
    <li>This example illustrates an inline SELECT statement. SQL injection may also be possible when stored procedures are used, if user input is incorporated dynamically, as above </li>
    <li>Inline SQL code may violate certain corporate information security policies</li>
  </ul>
  <h1>Test Case</h1>
  <p>The following classes must be included in any project making use of the sample code provided above:</p>
  <pre>using System.Data;<br />using System.Data.SqlClient;</pre>
  <p>The test case requires performance of the following three steps:</p>
  <p>1. Run the following CREATE table command to add the "people" table used in this query to your SQL server.</p>
  <pre>CREATE TABLE [dbo].[People](<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; [first] [varchar](50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; [last] [varchar](50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; [email] [varchar](max) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; [phone] [nchar](15) COLLATE SQL_Latin1_General_CP1_CI_AS NULL<br /></pre>
  <p>2. Create the stored procedure used in this example to query names from the people table.</p>
  <pre>CREATE PROCEDURE spFullNames AS<br />BEGIN<br />        SELECT first + ' ' + last FROM people ORDER BY last<br />END<br />GO</pre>
  <p>3. Execute the following test case code. </p>
  <pre>static void Main(string[] args){<br />        StoredProcedureDBQuery();<br />}</pre>
  <h1>Expected Result</h1>
  <pre>Result: Elvin Jones<br />Result: Gene Krupa<br />Result: Tony Williams</pre>
  <h1>More Information</h1>
  <ul>
    <li>User input should always be considered "tainted" and validated against a set of known and expected values or characters before acceptance by an application for processing in any type of operation, including database queries. </li>
  </ul>
  <br />
  <hr />
  <p>Adapted from Microsoft patterns &amp; practices guidance.</p>]]></Data>
  </Content>
</TeamMentor_Article>