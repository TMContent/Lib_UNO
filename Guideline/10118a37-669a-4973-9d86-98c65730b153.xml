<?xml version="1.0"?>
<TeamMentor_Article Metadata_Hash="1106526564" Content_Hash="-391436889">
  <Metadata>
    <Id>10118a37-669a-4973-9d86-98c65730b153</Id>
    <Id_History>10118a37-669a-4973-9d86-98c65730b153,1e067e5a-ce8c-45a6-ba87-4b55d89d0e15,</Id_History>
    <Library_Id>be5273b1-d682-4361-99d9-6234f2d47eb7</Library_Id>
    <Title>Use Global Error Handlers to Catch Unhandled Exceptions</Title>
    <Category>Error and Exception Management</Category>
    <Phase>Implementation</Phase>
    <Technology>ASP.NET 3.5</Technology>
    <Type>Guideline</Type>
    <DirectLink>Use Global Error Handlers to Catch Unhandled Exceptions</DirectLink>
    <Tag />
    <Security_Demand />
    <Author />
    <Priority>2</Priority>
    <Status />
    <Source>ASP.NET 3.5</Source>
  </Metadata>
  <Content Sanitized="true" DataType="Html">
    <Data><![CDATA[<br />
  <br />
  <h1>What to Do</h1>
  <p>Define an application-level global error handler in Global.asax to catch any exceptions that are not handled in code. </p>
  <h1>Why</h1>
  <p>Even if structured exception handling is used, not all application code will be wrapped in a Try/Catch/Finally block.&amp;nbsp; A global exception handler will ensure that these unhandled exceptions don't result in an error message to the client that will disclose internal application details.</p>
  <h1>When</h1>
  <p>This guideline is&amp;nbsp;applicable whenever there are application pages capable of generating exceptions of any kind. </p>
  <h1>How</h1>
  <p>Define an application-level global error handler in Global.asax to catch any exceptions that are not handled in code. Do this to avoid accidentally returning detailed error information to the client. You should log all exceptions in the event log to record them for tracking and later analysis. Use code similar to the following.</p>
  <pre>&lt;%@ Application Language="C#" %&gt; <br />&lt;%@ Import Namespace="System.Diagnostics" %&gt;  <br />&lt;script language="C#" runat="server"&gt; <br />void Application_Error(object sender, EventArgs e) <br />{    <br />	//get reference to the source of the exception chain    <br />	Exception ex = Server.GetLastError().GetBaseException();     <br />	// log the details of the exception and page state to the    <br />	// event log.    <br />	EventLog.WriteEntry("My Web Application",      <br />				"MESSAGE: " + ex.Message +       <br />				"\nSOURCE: " + ex.Source,       <br />				EventLogEntryType.Error);     <br />				// Optional e-mail or other notification here... <br />} <br />&lt;/script&gt;</pre>
  <h1>Problem Example</h1>
  <p>An ASP.NET application has code to connect to a SQL database.&amp;nbsp; However, the application does not have a generic error handler specified.&amp;nbsp; As a result, when the connection times out application details are revealed to the client in the exception.</p>
  <p>
    <strong>Description: </strong>An unhandled exception occurred during the execution of the current web request. Please review the stack trace for more information about the error and where it originated in the code. <br /><br /><b>Exception Details: </b>System.Data.SqlClient.SqlException: An error has occurred while establishing a connection to the server. &amp;nbsp;When connecting to SQL Server, this failure may be caused by the fact that under the default settings SQL Server does not allow remote connections. (provider: SQL Network Interfaces, error: 26 - Error Locating Server/Instance Specified)<br /><br /><b>Source Error:</b><br /><br /></p>
  <table>
    <tbody>
      <tr>
        <td>
          <pre>
            <br />Line 216:<br />Line 217:     if (conn.State != ConnectionState.Open)<br />Line 218:                conn.Open();<br />Line 219:<br />Line 220:            cmd.Connection = conn;</pre>
        </td>
      </tr>
    </tbody>
  </table>
  <p />
  <h1>Solution Example</h1>
  <p>An ASP.NET application has code to connect to a SQL database.&amp;nbsp; It has defined&amp;nbsp;an application-level global error handler to trap and log all unhandled exceptions.&amp;nbsp; This allows the application to present a generic error message to the client while logging more detailed information to the server.</p>
  <pre>&lt;%@ Application Language="C#" %&gt; <br />&lt;%@ Import Namespace="System.Diagnostics" %&gt;  <br />&lt;script language="C#" runat="server"&gt; <br />void Application_Error(object sender, EventArgs e) <br />{    <br />	//get reference to the source of the exception chain    <br />	Exception ex = Server.GetLastError().GetBaseException();     <br />	// log the details of the exception and page state to the    <br />	// event log.    <br />	EventLog.WriteEntry("My Web Application",      <br />				"MESSAGE: " + ex.Message +       <br />				"\nSOURCE: " + ex.Source,       <br />				EventLogEntryType.Error);     <br />	// Optional e-mail or other notification here... } <br />&lt;/script&gt;</pre>
  <hr />
  <p>Adapted from Microsoft patterns &amp; practices guidance. </p>]]></Data>
  </Content>
</TeamMentor_Article>