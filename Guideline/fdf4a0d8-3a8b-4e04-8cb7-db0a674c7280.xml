<?xml version="1.0"?>
<TeamMentor_Article Metadata_Hash="-976535523" Content_Hash="1469345724">
  <Metadata>
    <Id>fdf4a0d8-3a8b-4e04-8cb7-db0a674c7280</Id>
    <Id_History>0c6693ed-e3c2-4640-a795-c7c9c2a63cbc,</Id_History>
    <Library_Id>92718d53-36b2-47bc-b6f5-e60994385f46</Library_Id>
    <Title>Define a Security Policy</Title>
    <Category>Code Access Security</Category>
    <Phase>Design</Phase>
    <Technology>ASP.NET 3.5</Technology>
    <Type>Guideline</Type>
    <DirectLink>Define a Security Policy</DirectLink>
    <Tag />
    <Security_Demand />
    <Author />
    <Priority>2</Priority>
    <Status />
    <Source>SI</Source>
  </Metadata>
  <Content Sanitized="true" DataType="Html">
    <Data><![CDATA[<h1>What to Do</h1>
  <p>Define a security policy for your application while applying the Principle of Least Privilege. The security policy should specify which Code Access Security privileges should be granted to your application. Restrict the permission set to only allow the minimum set of necessary actions.</p>
  <h1>Why</h1>
  <p>Defining a security policy is a defense in-depth mechanism for restricting your application from performing tasks that the operating system would otherwise allow. This is especially important in cases where your application becomes compromised by an attacker.</p>
  <h1>When</h1>
  <p>ASP.NET web services and applications run in the full trust mode by default. Rarely will an application need the entire set of permissions. This guideline is applicable whenever an application does not require the entire set of permissions that are grantable in ASP.NET.</p>
  <h1>How</h1>
  <p>This guideline covers Code Access Security, which uses the defined policy to restrict the actions an application can perform regardless of the user context. It is also important to reduce the privilege level of the user context for the application. </p>
  <p>To define a Code Access Security policy for your application, follow these ordered steps:</p>
  <ol>
    <li>
      <p>
        <strong>Identify the permissions your application needs.</strong> Identify the precise set of code access security permissions that your application requires. You can do this by manually reviewing your code, or by using the Permissions Calculator (permcalc.exe). </p>
    </li>
    <li>
      <p>
        <strong>Choose an appropriate trust level.</strong> Use the following steps when choosing the appropriate trust level for your application:</p>
      <ol>
        <li>Evaluate whether the permissions required for your application match those provided by any of the standard trust levels. To see the permissions each trust level provides, examine each trust level policy file in the %windir%\Microsoft.NET\Framework\{version}\CONFIG directory, beginning with the High trust policy file web_hightrust.config. </li>
        <li>If your application requires fewer code access security permissions than those provided by the High trust level, move on to consider Medium trust. Repeat the process, moving from Medium to Low to Minimal, and keep evaluating the partial trust levels until you reach an exact match to your application's requirements or until your application's required permissions slightly exceed a partial trust level. </li>
        <li>If your application needs more permissions than are granted by one level but requires fewer that are provided by the next level, consider creating a custom trust policy.</li>
      </ol>
    </li>
    <li>
      <p>
        <strong>Configure your ASP.NET application.</strong> You can configure your ASP.NET application to use a standard level either in your application's Web.config file or in the machine-level Web.config file. Machine level configuration affects all the ASP.NET Web Applications and Web services hosted on that server. Application-level configuration affects only a specific application. </p>
      <pre>&lt;system.web&gt;<br />  ...<br />  &lt;trust level="Medium" originUrl="" /&gt;<br />  ...<br />&lt;/system.web&gt;</pre>
    </li>
    <li>
      <p>
        <strong>Optionally create a custom trust level.</strong> You may require a custom trust level if none of the predefined trust levels provide the exact set of permissions that your application needs to run. For example, you may find that your application needs more permissions than Medium trust provides but fewer permissions than High trust provides. Follow these steps when creating a custom policy:</p>
      <ol>
        <li>
          <p>Copy the trust level policy file that most closely matches your application's permission requirements to create a new custom policy file.</p>
        </li>
        <li>
          <p>Locate this file in the standard policy file directory, which is %Windir%\Microsoft.NET\Framework\{Version}\CONFIG. Add the required additional permissions to the custom policy file and configure your application to run using the custom policy. Example:</p>
          <pre>&lt;configuration&gt;<br />   &lt;mscorlib&gt;<br />      &lt;security&gt;<br />         &lt;policy&gt;<br />            &lt;PolicyLevel version="1"&gt;<br />               &lt;SecurityClasses&gt;<br />                  ...<br />                  &lt;SecurityClass Name="DnsPermission" Description="..."/&gt;<br />                  ...<br />               &lt;/SecurityClasses&gt;<br />               &lt;NamedPermissionSets&gt;<br />                  ...<br />                  &lt;PermissionSet<br />                        class="NamedPermissionSet"<br />                        version="1"<br />                        Name="ASP.Net"&gt;<br />                     &lt;IPermission<br />                           class="AspNetHostingPermission"<br />                           version="1"<br />                           Level="High"<br />                     /&gt;<br />                     &lt;IPermission<br />                           class="ConfigurationPermission"<br />                           version="1"<br />                           Unrestricted="true"<br />                     /&gt;<br />                     ...<br />                  &lt;/PermissionSet&gt;<br />                  ...<br />               &lt;/NamedPermissionSets&gt;<br />               &lt;CodeGroup<br />                     class="FirstMatchCodeGroup"<br />                     version="1"<br />                     PermissionSetName="Nothing"&gt;<br />                  &lt;IMembershipCondition<br />                        class="AllMembershipCondition"<br />                        version="1"<br />                  /&gt;<br />                  &lt;CodeGroup<br />                        class="UnionCodeGroup"<br />                        version="1"<br />                        PermissionSetName="ASP.Net"&gt;<br />                  ...<br />                  &lt;/CodeGroup&gt;<br />                  ...<br />               &lt;/CodeGroup&gt;<br />            &lt;/PolicyLevel&gt;<br />         &lt;/policy&gt;<br />      &lt;/security&gt;<br />   &lt;/mscorlib&gt;<br />&lt;/configuration&gt;</pre>
          <p>To learn more about the different code access permissions, visit <a href="http://msdn2.microsoft.com/en-us/library/h846e9b3(vs.80).aspx">Code Access Permissions</a>.</p>
        </li>
        <li>
          <p>Configure your application to run using the custom trust policy defined in the previous steps. Example:</p>
          <pre>&lt;location allowOverride="true"&gt;<br />   &lt;system.web&gt;<br />      &lt;securityPolicy&gt;<br />         &lt;trustLevel name="MyAppTrustLevel" policyFile="myapp_customtrust.config" /&gt;<br />      &lt;/securityPolicy&gt;<br />      &lt;trust level="MyAppTrustLevel" originUrl="" /&gt;<br />   &lt;/system.web&gt;&lt;/location&gt;</pre>
        </li>
      </ol>
    </li>
    <li>
      <p>
        <strong>Do not allow developers to change trust levels.</strong> Use the <a href="/article/01aa845d-9256-42e8-8504-df338a47a01e">Lock Configuration Settings to Enforce Policy Settings</a> guideline to lock the trust level set in your application's root web.config:</p>
      <pre>&lt;location allowOverride="false"&gt;<br />   &lt;system.web&gt;<br />      &lt;trust level="Medium" originUrl="" /&gt;<br />   &lt;/system.web&gt;<br />&lt;/location&gt;</pre>
    </li>
  </ol>
  <h1>Problem Example</h1>
  <p>A developer creates an ASP.NET application that requires file system access outside of the directory that is allocated for the application. The default Full Trust level does allow for file system access in the way that the application needs, however it also gives several unnecessary privileges such as socket access, and the ability to call unmanaged code. These additional privileges increase the amount of damage an attacker can do if the application is compromised.</p>
  <h1>Solution Example</h1>
  <p>A developer creates an ASP.NET application that requires file system access outside of the directory that is allocated for the application. The developer does not want to give full permissions to the application. The developer runs permcalc.exe on the assembly, which generates an xml report that identifies the precise permissions that the application requires, which are:</p>
  <ul>
    <li>
      <strong>SMTP access.</strong> Emails are sent on behalf of the application to notify users when important events occur, such as password reset acknowledgment responses and welcome emails for new users. </li>
    <li>
      <strong>Managed code only</strong>. The application is very modern, and relies on no unmanaged libraries to perform tasks. The application does not need to call unmanaged (native) code. </li>
    <li>
      <strong>Socket Access.</strong> The application relies on an older auditing package that employs a custom, socket based communication protocol. The application needs the ability to create a socket connection and read/write data from/to it.</li>
  </ul>
  <p>The developer looks at the Predefined trust levels, and determines that the lowest level of trust that the application can use and still satisfy it's requirements is the high trust level. She sets the trust level by adding an xml directive to the web config file:</p>
  <pre>&lt;system.web&gt;  ...  &lt;trust level="High" originUrl="" /&gt;  ...&lt;/system.web&gt;</pre>
  <h1>Additional Resources</h1>
  <ul>
    <li>To learn more about ASP.NET trust levels and policy files, visit: <a href="http://msdn2.microsoft.com/en-us/library/wyts434y(VS.80).aspx">ASP.NET Trust Levels and Policy Files</a>. </li>
    <li>To learn more about ASP.NET code access security, visit: <a href="http://msdn2.microsoft.com/en-us/library/87x8e4d1(VS.80).aspx">ASP.NET Code Access Security</a>. </li>
    <li>To learn more about the Permissions Calculator tool, visit: Documentation for <a href="http://msdn2.microsoft.com/en-us/library/ms165077(VS.80).aspx">Permission Calculator Tool</a> in MSDN. </li>
    <li>To learn more about the different code access permissions, visit: <a href="http://msdn2.microsoft.com/en-us/library/h846e9b3(vs.80).aspx">Code Access Permissions</a>. </li>
    <li>To learn more about configuring the security settings for a .NET assembly, visit: <a href="http://msdn2.microsoft.com/en-us/library/cb6t8dtz(VS.80).aspx">Code Access Security Policy Tool</a> in MSDN.</li>
  </ul>
  <h1>Related Items</h1>
  <ul>
    <li>
      <a href="/article/01aa845d-9256-42e8-8504-df338a47a01e">Guideline: Lock Configuration Settings to Enforce Policy Settings </a>
    </li>
    <li>
      <a href="/article/eb5dbadd-49ab-46e1-bc0d-d299eeb465f6">Guideline: Partition Code Into Separate Assemblies </a>
    </li>
    <li>
      <a href="/article/a053c4e4-2aad-41b9-b60b-e0fdeffd39f4">Guideline: Log Important Security Operations </a>
    </li>
    <li>
      <a href="/article/6a219806-df28-4c00-bc2d-c2ce4c721b7e">Attack: Trust Relationship Attack</a>
    </li>
    <li>
      <a href="/article/88134c36-4e54-47ca-8a83-fafe271ca05a">Attack: Luring Attack</a>
    </li>
    <li>
      <a href="/article/257481d8-fcc5-4ed2-a8d8-c198bb399c77">Checklist Item: A Security Policy is Defined</a>
    </li>
  </ul>
  <hr />
  <p>Adapted from Microsoft patterns &amp; practices guidance. </p>]]></Data>
  </Content>
</TeamMentor_Article>