<?xml version="1.0"?>
<TeamMentor_Article Metadata_Hash="-440887905" Content_Hash="-771603604">
  <Metadata>
    <Id>841f2ac4-a8c1-4526-a1d2-8e73e84be244</Id>
    <Id_History>37ff050f-192e-4f33-974a-b6be4347b901,</Id_History>
    <Library_Id>ea854894-8e16-46c8-9c61-737ef46d7e82</Library_Id>
    <Title>Use a Custom Policy If You Need to Access Non-SQL Server Databases from Partial Trust ASP.NET Applications</Title>
    <Category>Code Access Security</Category>
    <Phase>Deployment</Phase>
    <Technology>ADO.NET 2.0</Technology>
    <Type>Guideline</Type>
    <DirectLink>Use a Custom Policy If You Need to Access Non-SQL Server Databases from Partial Trust ASP.NET Applications</DirectLink>
    <Tag />
    <Security_Demand />
    <Author />
    <Priority>J.D. Meier, Alex Mackman, Blaine Wastell, Prashant Bansode, Chaitanya Bijwe</Priority>
    <Status />
    <Source>SI</Source>
  </Metadata>
  <Content Sanitized="true" DataType="Html">
    <Data><![CDATA[<h1>Applies to</h1>
  <ul>
    <li>ADO.NET 2.0</li>
  </ul>
  <h1>What to Do</h1>
  <p>If you need to access database types other than SQL Server by using an alternate provider, you must create a custom policy and grant the appropriate permission (such as <b>OleDbPermission</b>) to access non-SQL Server OLE DB data sources.</p>
  <h1>Why</h1>
  <p>An attacker can only cause damage within the bounds defined by the trust level set on the application. The less privilege your application has, the less damage potential an attacker will have.&amp;nbsp;</p>
  <p>Creating&amp;nbsp; a custom trust level allows you&amp;nbsp;to incrementally limit your exposure to security&amp;nbsp;attacks and provides&amp;nbsp;extra degrees of appication isolation.&amp;nbsp;</p>
  <h1>When</h1>
  <p>Default medium trust ASP.NET policy grants applications the <b>SqlClientPermission</b>. This means that Web applications configured to run at medium trust can access SQL Server databases.</p>
  <p>This guideline is to be followed when accessing non-SQL server databases from a medium trust application.</p>
  <h1>How</h1>
  <h3>Customizing Trust Level Policy</h3>
  <p />With this approach you do the following: <ol><li>Copy one of the existing trust level policy files to create a custom policy file. </li><li>Add the required permissions to the custom policy file. </li><li>Configure your application to run using the custom policy. </li></ol><blockquote><b>Note</b>&amp;nbsp;&amp;nbsp;&amp;nbsp;You are unlikely to be able to use this approach to customize the trust level in hosted environments, where policy restrictions are likely to be rigid.</blockquote><p /><b>To create the custom trust level configuration file</b><ol><li>Copy the Medium trust policy file, web_MediumTrust.config, which is located in the %windir%\Microsoft.NET\Framework\{version}\CONFIG\ directory to a file named Web_CustomTrust.config in the same directory. </li><li>Add the&amp;nbsp;required permission&amp;nbsp;security class definition to the &lt;<b>SecurityClass</b>&gt; section in the Web_CustomTrust.Config file, as shown in the following example. <pre>&lt;SecurityClass Name="OleDbPermission"<br />&amp;nbsp;Description="System.Security.Permissions.OleDbPermission, <br />mscorlib, Version=2.0.0.0, Culture=neutral, <br />PublicKeyToken=b77a5c561934e089"/&gt;  </pre></li><li>Add the unrestricted <b>OleDbPermission</b>to the "ASP.Net" named permission set. <pre>&lt;PermissionSet<br />&amp;nbsp;&amp;nbsp;&amp;nbsp; class="NamedPermissionSet"<br />&amp;nbsp;&amp;nbsp;&amp;nbsp; version="1"<br />&amp;nbsp;&amp;nbsp;&amp;nbsp; Name="ASP.Net"&gt;<br />&amp;nbsp; ...<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;IPermission<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; class="OleDbPermission"<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; version="1"<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Unrestricted="true" /&gt;<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; ...<br />&amp;nbsp;&amp;nbsp; &lt;/PermissionSet&gt;  </pre></li><li>Modify the default Web.config file in the %windir%\Microsoft.NET\Framework\{version}\CONFIG\ directory to add the custom trust level that references the custom trust configuration file you have created. </li><li>Add a new &lt;<b>trustLevel</b>&gt; element to the &lt;<b>securityPolicy</b>&gt;<b></b>section of the Web.config file to define a new level called <b>"Custom"</b> and to associate it with the custom policy file. <pre>&lt;location allowOverride="true"&gt;<br />&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;system.web&gt;<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;securityPolicy&gt;<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;trustLevel name="Full" policyFile="internal" /&gt;<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;trustLevel name="High" policyFile="web_hightrust.config" /&gt;<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;trustLevel name="Medium" policyFile="web_mediumtrust.config" /&gt;<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;trustLevel name="Low" policyFile="web_lowtrust.config" /&gt;<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;trustLevel name="Minimal" policyFile="web_minimaltrust.config" /&gt;<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;trustLevel name="Custom" policyFile="web_CustomTrust.config" /&gt;<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;/securityPolicy&gt;<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;trust level="Full" originUrl="" /&gt;<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;/system.web&gt;<br />&amp;nbsp;&amp;nbsp; &lt;/location&gt;</pre></li></ol><p>The preceding changes apply to the root Web.config file in the framework CONFIG folder. This applies defaults to all Web applications on the current server. </p><p /><b>To configure the trust level for your specific application</b><ol><li>Copy the web_CustomTrust.config file to your application's virtual directory. </li><li>Instead of referring to the Web_CustomTrust.config from the machine-level Web.config file, refer to it directly from your application's Web.config, as shown in the following example. <pre>...<br />&lt;location allowOverride="true"&gt;<br />&amp;nbsp;&amp;nbsp; &lt;system.web&gt;<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;securityPolicy&gt;<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;trustLevel name="Custom" policyFile="web_CustomTrust.config" /&gt;<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;/securityPolicy&gt;<br />&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;trust level="Custom" originUrl="" /&gt;<br />&amp;nbsp; &lt;/system.web&gt;<br />&lt;/location&gt;<br />&amp;nbsp;...</pre></li></ol><br /><hr /><p>Adapted from Microsoft patterns &amp; practices guidance.</p>]]></Data>
  </Content>
</TeamMentor_Article>