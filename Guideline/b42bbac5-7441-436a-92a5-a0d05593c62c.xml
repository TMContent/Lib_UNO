<?xml version="1.0"?>
<TeamMentor_Article Metadata_Hash="-136275317" Content_Hash="70481481">
  <Metadata>
    <Id>b42bbac5-7441-436a-92a5-a0d05593c62c</Id>
    <Id_History>b42bbac5-7441-436a-92a5-a0d05593c62c,3b74ef6a-7a6f-44d4-a327-c68f4ab15297,</Id_History>
    <Library_Id>26bd1a04-beed-4a66-917d-b6ab0a7d634c</Library_Id>
    <Title>Encrypt SQL Connection Strings with RSA on Web Farms</Title>
    <Category>Database Security</Category>
    <Phase>Implementation</Phase>
    <Technology>ASP.NET 4.0</Technology>
    <Type>Guideline</Type>
    <DirectLink>Encrypt SQL Connection Strings with RSA on Web Farms</DirectLink>
    <Tag />
    <Security_Demand />
    <Author />
    <Priority />
    <Status />
    <Source>SI</Source>
  </Metadata>
  <Content Sanitized="true" DataType="Html">
    <Data><![CDATA[<h1>Applies To</h1>
  <ul>
    <li>ASP.NET 4.0</li>
  </ul>
  <h1>What to Do</h1>
  <p>Use the RSA Protected Configuration provider to encrypt sections of your configuration files. You can use <em>Aspnet_regiis.exe</em> tool to encrypt sensitive data, such as connection strings, held in the <em>Web.config</em> and <em>Machine.config</em> files.&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;</p>
  <h1>Why</h1>
  <p>Connection strings contain sensitive resource access credentials (e.g., a connection string for a SQL server resource includes a username and password.) Connection strings stored in plaintext are dangerous, because an attacker that can compromise a server will be able to read those connection strings. Even if a machine is not compromised, connection strings stored in plain text&amp;nbsp;are accessible to administrators and any other users with sufficient privileges&amp;nbsp;on the host machine and/or Windows domain.&amp;nbsp;</p>
  <h1>When</h1>
  <p>Always encrypt connection strings. In&amp;nbsp;a web farm environment,&amp;nbsp;the RSA protected configuration provider is an effective way to encrypt and decrypt configuration file sections&amp;nbsp;because it uses asymmetric encryption to encrypt and decrypt,&amp;nbsp;meaning&amp;nbsp;the keys can easily be exported and imported&amp;nbsp;from server to server.&amp;nbsp; If the application is no deployed to a web farm environment DPAPI will work as well as RSA for encrypting connection strings.&amp;nbsp; </p>
  <h1>How</h1>
  <p>Use the following steps to encrypt sections of your configuration files: </p>
  <ol>
    <li>
      <p>
        <strong>Identify the configuration sections to be encrypted.</strong> Encrypting and decrypting data incurs performance overhead. To keep this overhead to a minimum, encrypt only the sections of your configuration file that store sensitive data. In this case, we are interested in encrypting the &lt;<em>connectionStrings</em>&gt; element of the <em>Web.config</em> file since that is where the database connection string will reside. </p>
    </li>
    <li>
      <p>
        <strong>Choose the machine or user store.</strong> The DataProtectionConfigurationProvider supports machine-level and user-level stores for key storage. The choice of store depends largely on whether or not your application shares a server with other applications and whether or not sensitive data must be kept private for each application. </p>
    </li>
    <li>
      <p>
        <strong>Encrypt your configuration file data.</strong> Use the RSA Provider to Encrypt a Connection String in <em>Web.config</em> in a Web Farm. To do this, you must create a custom RSA encryption key container and deploy the same key container on all servers in your Web farm. This won't work by default because the default RSA encryption key, "<em>NetFrameworkConfigurationKey</em>", is different for each computer.</p>
      <p>Run&amp;nbsp;the following command from a .NET command prompt to encrypt the <em>connectionStrings</em> section using the machine level store:</p>
      <pre>aspnet_regiis -pe "connectionStrings" -app "/MachineRSA"</pre>
      <p>
        <strong>Note</strong>: If your ASP.NET application identity does not have access to the .NET Framework configuration key store, you'll need to grant access.</p>
    </li>
  </ol>
  <h1>Problem Example</h1>
  <p>A web application is running in&amp;nbsp;a web farm environment. The application uses an SQL database instance and has sensitive data that should not be accessible to&amp;nbsp;other applications on the same system.&amp;nbsp;The <em>Web.config</em> file contains a <em>connectionString</em> section that&amp;nbsp;the application uses to access the SQL database across all machines in the farm:</p>
  <pre>&lt;connectionStrings&gt;  <br />&lt;add name="MyLocalSQLServer"        <br />	connectionString="Initial Catalog=pubs;User Id=sa;Password=asdasd;       <br />	data source=localhost;Integrated Security=SSPI;"      <br />	providerName="System.Data.SqlClient"/&gt;<br />&lt;/connectionStrings&gt;</pre>
  <p>Unfortunately,&amp;nbsp;anyone capable of reading the web.config file for the application is now able to see the database, the username, and the password for the database instance, and will be able to execute statements at the same level of privilege as the application.</p>
  <h1>Solution Example</h1>
  <p>The <em>Web.config</em> file for an application running in a web farm environment contains a <em>connectionString</em> section that&amp;nbsp;the application uses to access the SQL database across all machines in the farm:</p>
  <pre>&lt;connectionStrings&gt;  <br />&lt;add name="MyLocalSQLServer"        <br />	connectionString="Initial Catalog=pubs;User Id=sa;Password=asdasd;       <br />	data source=localhost;Integrated Security=SSPI;"       <br />	providerName="System.Data.SqlClient"/&gt;<br />&lt;/connectionStrings&gt;</pre>
  <p>Use <em>RSAProtectedConfigurationProvider</em>&amp;nbsp;with the&amp;nbsp;machine key&amp;nbsp;store to encrypt&amp;nbsp;the <em>connectionStrings</em> section. Add and configure a protected configuration provider to use the&amp;nbsp;machine key&amp;nbsp;store and run the following command from to encrypt the <em>connectionStrings</em>:</p>
  <pre>aspnet_regiis -pe "connectionStrings" -app "/MachineRSA"</pre>
  <p>At this point the connection string has been encrypted, which can be verified by looking at the <em>Web.config</em> file. There is no need to decrypt the file by hand, since ASP.NET handles this transparently.&amp;nbsp;</p>
  <hr />
  <p>Adapted from Microsoft patterns &amp; practices guidance. </p>]]></Data>
  </Content>
</TeamMentor_Article>