<?xml version="1.0"?>
<TeamMentor_Article Metadata_Hash="275142989" Content_Hash="1343518471">
  <Metadata>
    <Id>7f659253-3a3f-4ff1-85c0-9d7c34fb416b</Id>
    <Id_History>57879551-b9d0-4f4b-9777-f080c36f9397,</Id_History>
    <Library_Id>ea854894-8e16-46c8-9c61-737ef46d7e82</Library_Id>
    <Title>When Using SQL Authentication, Protect Credentials in Configuration Files</Title>
    <Category>Data Access</Category>
    <Phase>Implementation</Phase>
    <Technology>ASP.NET 2.0</Technology>
    <Type>Guideline</Type>
    <DirectLink>When Using SQL Authentication, Protect Credentials in Configuration Files</DirectLink>
    <Tag />
    <Security_Demand />
    <Author />
    <Priority>J.D. Meier, Alex Mackman, Blaine Wastell, Prashant Bansode, Andy Wigley, Kishore Gopalan</Priority>
    <Status />
    <Source>SI</Source>
  </Metadata>
  <Content Sanitized="true" DataType="Html">
    <Data><![CDATA[<h1>Applies to</h1>
  <ul>
    <li>ASP.NET 2.0&amp;nbsp;</li>
  </ul>
  <h1>What to Do</h1>
  <p>If your application relies on SQL authentication, credentials must be protected in configuration files. Use a protected&amp;nbsp;configuration provider to&amp;nbsp;encrypt connection strings before&amp;nbsp;storing them in configuration files. </p>
  <h1>Why</h1>
  <p>Connection strings contain sensitive resource access credentials (e.g., a connection string for a SQL server resource includes a username and password.) Connection strings stored in plaintext are dangerous, because an attacker that can compromise a server will be able to read those connection strings. Even if a machine is not compromised, connection strings stored in plain text&amp;nbsp;are accessible to administrators and any other users with sufficient privileges&amp;nbsp;on the host machine and/or Windows domain.&amp;nbsp;</p>
  <h1>When</h1>
  <p>Always encrypt connection strings. The Windows Data Protection API (DPAPI) is the default provider and is&amp;nbsp;an acceptable choice when choosing a protected configuration provider under most circumstances. However, in a Web farm environment,&amp;nbsp;the RSA-protected configuration provider is a good choice because the RSA-based provider use asymmetric, public&amp;nbsp;key encryption to encrypt and decrypt data keys that can be exported and imported across servers. If neither of these suffice, you can create your own custom provider</p>
  <h1>How</h1>
  <p>
    <strong>1. Identify the configuration sections to be encrypted.</strong> Encrypting and decrypting data incurs performance overhead. To keep this overhead to a minimum, encrypt only the sections of your configuration file that store sensitive data. In this case, we are interested in encrypting the &lt;connectionStrings&gt; element of the Web.config file since that is where the database connection string will reside. </p>
  <p>
    <strong>2. Choose the protected configuration provider. </strong>Under most circumstances DPAPI will suffice, although the RSA protected configuration is the logical choice in web farms where multiple servers are employed. The .NET Framework 2.0 introduces a protected configuration feature that you can use to encrypt sensitive configuration file data by using a command line tool. The following two protected configuration providers are provided although you can also implement custom providers.</p>
  <p>
    <strong>RSA Protected Configuration Provider.</strong> This provider uses RSA public&amp;nbsp;key encryption to encrypt and decrypt data and is a good choice for web farm environments. </p>
  <p>
    <strong>DPAPIProtectedConfigurationProvider.</strong> This is the default provider, which&amp;nbsp;uses the Windows Data Protection API (DPAPI) to encrypt and decrypt data. This section describes how to use DPAPI to encrypt connection strings. Please check the related guidelines for more information on using the RSA Protected Configuration Provider and DPAPI.</p>
  <p>
    <strong>3. Choose the machine or user store.</strong> The DataProtectionConfigurationProvider supports machine-level and user-level stores for key storage. The choice of store depends largely on whether or not your application shares a server with other applications and whether or not sensitive data must be kept private for each application. </p>
  <p>
    <strong>Machine Store</strong>
  </p>
  <blockquote>
    <p>By default, the DataProtectionConfigurationProvider is configured to use DPAPI with the machine store. Use machine-level key storage in the following situations:</p>
    <ul>
      <li>Your application runs on its own dedicated server with no other applications. </li>
      <li>You have multiple applications on the same server that run and you want those applications to be able to share sensitive information.</li>
    </ul>
  </blockquote>
  <p>
    <strong>User Store</strong>
  </p>
  <blockquote>
    <p>Use user-level key storage if you run your application in a shared hosting environment and you want to make sure that your application's sensitive data is not accessible to other applications on the server. In this situation, each application should run under a separate identity, and the resources for the application—such as files and databases—should be restricted to that identity.</p>
  </blockquote>
  <p>
    <strong>4. Encrypt your configuration file data.</strong> To encrypt the connectionStrings section in Web.config using DPAPI with the Machine Store, run the following command from a .NET command prompt:</p>
  <pre>   aspnet_regiis -pe "connectionStrings" -app "/MachineDPAPI" -prov "DataProtectionConfigurationProvider" </pre>
  <p>The above command with the -app switch assumes that there is an IIS virtual directory called MachineDPAPI. If you are using the Visual Studio .NET 2005 Web server instead of IIS, use the -pef switch, which allows you to specify the physical directory location of your configuration file.</p>
  <pre>   aspnet_regiis.exe -pef "connectionStrings" C:\Projects\MachineDPAPI -prov "DataProtectionConfigurationProvider"&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;</pre>
  <h1>Problem Example</h1>
  <p>Let's say that a sample web application is running in&amp;nbsp;a hosted web environment. The application uses an SQL database instance and has sensitive data that should not be accessible to&amp;nbsp;other applications on the same system.&amp;nbsp;The web.config file contains a connectionString section that&amp;nbsp;the application uses to access the SQL database:</p>
  <pre>&lt;connectionStrings&gt; <br />	&lt;add name="MyLocalSQLServer"        <br />			connectionString="Initial Catalog=pubs;<br />			User Id=sa;<br />			Password=asdasd;       <br />			data source=localhost;<br />			Integrated Security=SSPI;"       <br />	providerName="System.Data.SqlClient"/&gt;<br />&lt;/connectionStrings&gt;</pre>
  <p>This connection string is dangerous, because anyone who is capable of reading the web.config file for the application is now able to discern the database, the username, and the password for the database instance, and will be able to execute statements at the same level of privilege as the application.</p>
  <h1>Solution Example</h1>
  <p>Since this is application is in a shared hosting environment, the user store is the appropriate choice for key storage. By default, the ASP.NET applications run under the NT AUTHORITY\Network Service account. When you access encrypted configuration sections using DPAPI with the user store, make sure that your application is running with the same user identity as the account you used to encrypt the data.</p>
  <p>Using the DataProtectionConfigurationProvider and DPAPI with the user store requires a small amount of additional configuration in the Web.config file.</p>
  <p>First, you add and configure a protected configuration provider to use the user store. To do this, the following &lt;configProtectedData&gt; section is added, and the&amp;nbsp;directive useMachineProtection= "false" to instruct the provider to use the user store. It's imperative that&amp;nbsp;a unique provider name is used, or a run-time error will occur.</p>
  <blockquote>
    <pre>&lt;configProtectedData&gt;<br />&amp;nbsp; &lt;providers&gt;<br />&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;add useMachineProtection="false" keyEntropy="" name="MyUserDataProtectionConfigurationProvider" <br />		type="System.Configuration.DpapiProtectedConfigurationProvider, System.Configuration, <br />		Version=2.0.0.0, Culture=neutral, <br />PublicKeyToken=b03f5f7f11d50a3a" /&gt;<br />&amp;nbsp; &lt;/providers&gt;<br />&lt;/configProtectedData&gt;&amp;nbsp; </pre>
  </blockquote>
  <p>The following command is run from a command prompt to encrypt the connectionStrings section:</p>
  <blockquote>
    <pre>Aspnet_regiis -pe "connectionStrings" -app "/UserDPAPI" -prov "MyUserDataProtectionConfigurationProvider"</pre>
  </blockquote>
  <ul>
    <li>The -pe switch specifies the configuration section to encrypt. </li>
    <li>The -app switch specifies your Web application's virtual path. If it is a nested application, you need to specify the nested path from the root directory; for example: "/test/aspnet/UserDPAPI". </li>
    <li>The -prov switch specifies the provider name. In this case, this is set to "MyUserDataProtectionConfigurationProvider" which is the name you specified earlier.</li>
  </ul>
  <p>At this point the connection string has been encrypted, which can be verified by looking at the web.config file.&amp;nbsp;&amp;nbsp; </p>
  <br />
  <hr />
  <p>Adapted from Microsoft patterns &amp; practices guidance.</p>]]></Data>
  </Content>
</TeamMentor_Article>