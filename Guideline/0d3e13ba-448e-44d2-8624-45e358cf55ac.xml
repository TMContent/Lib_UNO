<?xml version="1.0"?>
<TeamMentor_Article Metadata_Hash="-1598618613" Content_Hash="-496305618">
  <Metadata>
    <Id>0d3e13ba-448e-44d2-8624-45e358cf55ac</Id>
    <Id_History>4f7ff07d-ff50-4472-8f46-2143dd5068e6,</Id_History>
    <Library_Id>ea854894-8e16-46c8-9c61-737ef46d7e82</Library_Id>
    <Title>Consider Using DPAPI to Avoid Key Management</Title>
    <Category>Cryptography</Category>
    <Phase>Implementation</Phase>
    <Technology>.NET 2.0</Technology>
    <Type>Guideline</Type>
    <DirectLink>Consider Using DPAPI to Avoid Key Management</DirectLink>
    <Tag />
    <Security_Demand />
    <Author />
    <Priority>J.D. Meier, Alex Mackman, Blaine Wastell, Prashant Bansode, Chaitanya Bijwe</Priority>
    <Status />
    <Source>SI</Source>
  </Metadata>
  <Content Sanitized="true" DataType="Html">
    <Data><![CDATA[<h1>Applies to</h1>
  <ul>
    <li>
      <div>.NET 2.0</div>
    </li>
  </ul>
  <h1>What to Do</h1>
  <p>Use DPAPI to encrypt sensitive information, either in memory or in persistent stores such as configuration files or registry entries.</p>
  <h1>Why</h1>
  <p>By using DPAPI you avoid having to manage and protect the encryption key. With DPAPI, the operating system manages and protects the key.</p>
  <h1>When</h1>
  <p>When encrypting sensitive information in memory or in persistent stores.</p>
  <h1>How</h1>
  <p>For sensitive data stored in ASP.NET Web.config files, you can use the Aspnet_regiis tool and the data protection feature provided with ASP.NET 2.0. <br /></p>
  <blockquote>
    <b>Note</b>&amp;nbsp;&amp;nbsp;&amp;nbsp;DPAPI encryption is not recommended for use in Web farm scenarios because of machine affinity. Instead, you should use RSA encryption, which is also supported by the Aspnet_regiis tool.<b></b></blockquote>
  <p>For sensitive data stored in memory, you can use the <b>ProtectedMemory </b>class which provides a managed wrapper for DPAPI to encrypt the data. For text-based data, consider using <b>SecureString </b>instead.<b> SecureString</b> uses the <b>ProtectedMemory</b> class to encrypt text in memory<b>.</b></p>
  <p>The following example shows how to use the <b>ProtectedMemory</b> class for encrypting and decrypting data in memory.</p>
  <pre>using System.Security.Cryptography;using System.Text;<br />...byte[] optionalEntropy = {7,5,4,9,0};<br />byte[] dataToBeEncrypted = Encoding.Unicode.GetBytes("Test String 1211");<br />ProtectedMemory.Protect(dataToBeEncrypted, MemoryProtectionScope.SameLogon);<br />ProtectedMemory.Unprotect(dataToBeEncrypted, MemoryProtectionScope.SameLogon);<br />string originalData = Encoding.Unicode.GetString(dataToBeEncrypted);  </pre>
  <p>For sensitive data stored in any other data store, use the <b>ProtectedData </b>class as shown in the following example.</p>
  <pre>using System.Security.Cryptography;<br />using System.Text;<br />...byte[] optionalEntropy = {7,5,4,9,0};<br />byte[] dataToBeEncrypted = Encoding.Unicode.GetBytes("Test String");<br />byte[] encryptedData = ProtectedData.Protect(dataToBeEncrypted, optionalEntropy, <br />				DataProtectionScope.CurrentUser);<br />byte[] decryptedData = ProtectedData.Unprotect(encryptedData, optionalEntropy, <br />				DataProtectionScope.CurrentUser);            <br />string originalData = Encoding.Unicode.GetString(decryptedData);  </pre>
  <p />When you use DPAPI, you can use the machine key store or the user key store. Use machine-level key storage in the following situations: <ul><li>Your application runs on its own dedicated server with no other applications. </li><li>You have multiple applications on the same server, and you want those applications to be able to share sensitive information. </li></ul><p>Use user-level key storage if you run your application in a shared hosting environment and you want to make sure that your application's sensitive data is not accessible to other applications on the server. In this situation, each application should run under a separate identity, and the resources for the application—such as files and databases—should be restricted to that identity.</p><hr /><p>Adapted from Microsoft patterns &amp; practices guidance.</p>]]></Data>
  </Content>
</TeamMentor_Article>