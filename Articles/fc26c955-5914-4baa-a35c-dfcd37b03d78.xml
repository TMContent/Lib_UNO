<?xml version="1.0"?>
<TeamMentor_Article Metadata_Hash="0" Content_Hash="0">
  <Metadata>
    <Id>fc26c955-5914-4baa-a35c-dfcd37b03d78</Id>
    <Id_History>19f2779c-14ec-43fb-8e8d-4505cb0801c9,</Id_History>
    <Library_Id>d9c2b53f-5b05-4152-be72-e79d72854707</Library_Id>
    <Title>Include Unique Tokens in HTTP Requests</Title>
    <Category>Session Management</Category>
    <Phase>Implementation</Phase>
    <Technology>Scala with Play Framework</Technology>
    <Type>Guideline</Type>
    <DirectLink>Include Unique Tokens in HTTP Requests</DirectLink>
    <Author />
    <Priority />
    <Status />
  </Metadata>
  <Content Sanitized="false" DataType="html">
    <Data><![CDATA[<h1>Applies to</h1>
  <p>Scala and Play Framework 2.1.0+</p>
  <h1>What to Do</h1>
  <p>Include unique tokens in HTTP requests when performing sensitive operations to prevent Cross-Site Request Forgery (CSRF).</p>
  <h1>Why</h1>
  <p>Unique tokens in HTTP requests help prevent CSRF attacks. An attacker who does not have the unique token will not be able to successfully form a URL that can carry out a malicious action on the behalf of an authenticated user. <br /></p>
  <h1>How</h1>
  <p>To include unique tokens in HTTP requests:</p>
  <ol>
    <li>
      <p>
        <strong>Identify sensitive operations.</strong>&amp;nbsp;Review application design and code to identify all operations that require authorization.</p>
    </li>
    <li>
      <p>
        <strong>Identify code that performs sensitive operations.&amp;nbsp;</strong>Identify all pages that are involved in performing sensitive operations. This includes both the pages that link to sensitive operations and the code that actually carries out the sensitive operations.</p>
    </li>
    <li>
      <p />
      <strong>Choose a method for generating unique tokens.</strong>&amp;nbsp;There are different ways to generate unique tokens. In Play Framework, use a <a href="https://github.com/orefalo/play2-authenticitytoken">Play 2 Authenticity token</a>
 for this purpose.&amp;nbsp; Every form post will contain a hidden parameter 
containing a UUID. The UUID is signed and its signature is stored in the
 session. When the user submits the form, it includes the UUID and the 
signature. The validation passes if the signatures match: <font face="Courier New">session.sign=uuid.sign</font>.
 An attacker who does not have the token cannot generate the correct 
signature. This protects the application from a CSRF attack. </li>
    <li>
      <p />
      <strong>Add unique tokens to HTTP requests.</strong>&amp;nbsp;Add code that sends
 the generated unique tokens in HTTP requests to the pages that link to 
sensitive operations. Adding the authenticity token is trivial: For 
every form, add @authenticityToken() inside the form elements. For example:<pre>@import _root_.views.html.authtoken.authenticityToken

&lt;form action="@routes.Application.process()" method="post"&gt;
   @authenticityToken()
   Please input your name
   &lt;input name="name" /&gt;
   &lt;input type="submit"/&gt;
&lt;/form&gt;</pre></li>
    <li>
      <p />
      <strong>Add token-validation code.</strong> On the pages that carry out sensitive operations, add code that checks if the tokens sent in HTTP requests are valid or not. To validate the token, use the @AuthenticityToken Play validator. For example:<pre>import authtoken.validator.AuthenticityToken;<br /><br />public class FormData {<br /><br />    @AuthenticityToken<br />    public String authtoken;<br /><br />    public String name;<br />}<br /><br />public static Result process() {<br /><br />    Form<formdata> form = form(FormData.class).bindFromRequest();<br /><br />    if (form.hasErrors()) {<br />        return badRequest("authenticity validation FAILED");<br />    } else {<br />        return ok("authenticity validation PASSED");<br />    }<br />}</formdata></pre></li>
  </ol>
  <h1>Additional Resources</h1>
  <ul>
    <li>For information about the OWASP CSRFGuard project, please see&amp;nbsp;<a href="https://www.owasp.org/index.php/Category:OWASP_CSRFGuard_Project">https://www.owasp.org/index.php/Category:OWASP_CSRFGuard_Project</a></li>
    <li>Sample code for Play 2 Authenticity Token can be seen&amp;nbsp;<a href="https://github.com/orefalo/play2-authenticitytoken">https://github.com/orefalo/play2-authenticitytoken</a></li>
    <li>
      <a href="https://github.com/jacobgroundwater/Scala-Play-CSRF">Here</a> is another way of implementing unique tokens in Play Framework successfully using cookie and hidden-field approach.</li>
  </ul>
  <div>
    <h1 style="margin: 0px; padding: 10px 0px 0px; font-size: 17px; font-family: 'Segoe UI', 'Helvetica Neue', Helvetica, Arial, sans-serif; background-color: rgb(255, 255, 255);">Session Management Guidelines</h1>
    <ul style="margin: 10px 0px 10px 25px; padding: 0px 0px 0px 30px; font-family: 'Segoe UI', 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: small; background-color: rgb(255, 255, 255);">
      <li style="margin: 0px; padding: 0px;">
        <b>
          <a href="13ad7fa3-199e-4957-9e4f-39bd931c9f1d">Protect Session IDs</a>
        </b>
      </li>
      <li style="margin: 0px; padding: 0px;">
        <b>
          <a href="5d296e90-a27c-424a-bfe1-5576490b50c2">Protect Session Cookies</a>
        </b>
      </li>
      <li style="margin: 0px; padding: 0px;">
        <b>
          <a href="f4218f89-d394-4162-8108-faef064f0f65">Set the Domain and Path Values of Session Cookies</a>
        </b>
      </li>
      <li style="margin: 0px; padding: 0px;">
        <b>
          <a href="0c4222a4-6028-4191-8dcb-761bbb4d2661">Set the Secure and HTTPOnly Flags on All Sensitive Cookies</a>
        </b>
      </li>
      <li style="margin: 0px; padding: 0px;">
        <b>
          <a href="b8e65bce-05bb-40b0-bc5b-ea6fe1e3ce96">Change Session IDs During Authentication</a>
        </b>
      </li>
      <li style="margin: 0px; padding: 0px;">
        <b>
          <a href="05a2cfa6-d015-446b-8c25-3cb13f10d396">Invalidate Sessions when Users Log Out</a>
        </b>
      </li>
      <li style="margin: 0px; padding: 0px;">
        <b>
          <a href="6ac43864-2644-4f33-bfb2-1366c5c3cb58">Make Inactive Sessions Time-out</a>
        </b>
      </li>
      <li style="margin: 0px; padding: 0px;">
        <b>
          <a href="19f2779c-14ec-43fb-8e8d-4505cb0801c9">Include Unique Tokens in HTTP Requests</a>
        </b>
      </li>
      <li style="margin: 0px; padding: 0px;">
        <b>
          <a href="7889a5ad-4e61-41da-97da-d40337050e17">Do Not Make Security Decisions Based on Client-Accessible Parameters</a>
        </b>
      </li>
    </ul>
    <h1 style="margin: 0px; padding: 10px 0px 0px; font-size: 17px; font-family: 'Segoe UI', 'Helvetica Neue', Helvetica, Arial, sans-serif; background-color: rgb(255, 255, 255);">Session Management Checklists</h1>
    <ul style="margin: 10px 0px 10px 25px; padding: 0px 0px 0px 30px; font-family: 'Segoe UI', 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: small; background-color: rgb(255, 255, 255);">
      <li style="margin: 0px; padding: 0px;">
        <b>
          <a href="9dfbcbed-d897-4df4-b212-9d80fb26cbdf">Session IDs Are Protected</a>
        </b>
      </li>
      <li style="margin: 0px; padding: 0px;">
        <b>
          <a href="fe0a7400-2140-4e9e-bcc7-f185acce6974">Session Cookies are Protected</a>
        </b>
      </li>
      <li style="margin: 0px; padding: 0px;">
        <b>
          <a href="932cd357-dfd4-4f95-949b-e407b5299748">The Domain and Path Values of Session Cookies Are Strict</a>
        </b>
      </li>
      <li style="margin: 0px; padding: 0px;">
        <b>
          <a href="0679ade9-860f-42e0-b811-2a3434410a76">The Secure and HTTPOnly Flags Are Set on All Sensitive Cookies</a>
        </b>
      </li>
      <li style="margin: 0px; padding: 0px;">
        <b>
          <a href="3328e0df-abe9-4339-9eeb-fae6eb54042e">Session IDs Are Changed During Authentication</a>
        </b>
      </li>
      <li style="margin: 0px; padding: 0px;">
        <b>
          <a href="636b0c98-34d0-4aed-bf06-35f80a6e5551">Sessions Are Invalidated When Users Log Out</a>
        </b>
      </li>
      <li style="margin: 0px; padding: 0px;">
        <b>
          <a href="22c6bd72-94a7-4b86-9c9b-60d921fbd266">Inactive Sessions Time-out</a>
        </b>
      </li>
      <li style="margin: 0px; padding: 0px;">
        <b>
          <a href="178b26f6-689b-4a0e-a117-eadf1af3404c">Unique Tokens Are Included in HTTP Requests</a>
        </b>
      </li>
    </ul>
  </div>]]></Data>
  </Content>
</TeamMentor_Article>