<?xml version="1.0"?>
<TeamMentor_Article Metadata_Hash="0" Content_Hash="0">
  <Metadata>
    <Id>178b26f6-689b-4a0e-a117-eadf1af3404c</Id>
    <Id_History>178b26f6-689b-4a0e-a117-eadf1af3404c,48d7b6bf-8989-47be-9454-033171ce2339,</Id_History>
    <Library_Id>d9c2b53f-5b05-4152-be72-e79d72854707</Library_Id>
    <Title>Unique Tokens Are Included in HTTP Requests</Title>
    <Category>Session Management</Category>
    <Phase>Implementation</Phase>
    <Technology>Scala with Play Framework</Technology>
    <Type>Checklist Item</Type>
    <DirectLink>Unique Tokens Are Included in HTTP Requests</DirectLink>
    <Author />
    <Priority />
    <Status />
  </Metadata>
  <Content Sanitized="false" DataType="html">
    <Data><![CDATA[<h1>Applies to</h1>
  <p>Scala and Play Framework 2.1.0+<br /></p>
  <h1>What to Check For</h1>
  <p>Verify that unique tokens are included in HTTP requests in hidden fields.</p>
  <h1>Why</h1>
  <p>CSRF may be possible when an attacker can form a URL, which performs an action on the behalf of an authenticated user. Forming such URLs becomes much more difficult if unique tokens are included in HTTP requests. Including difficult to predict tokens in HTTP requests is an effective defense against CSRF attacks.</p>
  <h1>How to Check</h1>
  <p>To verify that unique tokens are included in HTTP requests:</p>
  <ol>
    <li>
      <p>
        <strong>Identify sensitive operations.</strong>&amp;nbsp;Review application design and code to identify all operations that require authorization.</p>
    </li>
    <li>
      <p>
        <strong>Identify code that performs sensitive operations.</strong>&amp;nbsp;Identify all pages that are involved in performing sensitive operations - this includes both the pages that link to sensitive operations and the code that actually carries out the sensitive operations.</p>
    </li>
    <li>
      <p>
        <strong>Examine code that performs sensitive operations.</strong>&amp;nbsp;Review each page that allows calling sensitive operations to make sure that it stores a unique token in a session variable. Review each page that allows calling sensitive operations to make sure that it sends the unique token with the request in a hidden field. Review each page that performs sensitive information to make sure that it validates the unique token.</p>
    </li>
  </ol>
  <h1>How to Fix</h1>
  <p />
  <p>To include unique tokens in HTTP requests:</p>
  <ol>
    <li>
      <p>
        <strong>Identify sensitive operations.</strong>&amp;nbsp;Review application design and code to identify all operations that require authorization.</p>
    </li>
    <li>
      <p>
        <strong>Identify code that performs sensitive operations.&amp;nbsp;</strong>Identify all pages that are involved in performing sensitive operations - this includes both the pages that link to sensitive operations and the code that actually carries out the sensitive operations.</p>
    </li>
    <li>
      <p />
      <strong>Choose a method for generating unique tokens.</strong>&amp;nbsp;There are different ways to generate unique tokens.&amp;nbsp;<a href="https://github.com/orefalo/play2-authenticitytoken">Play 2 Authenticity tokens</a>&amp;nbsp;can be used for this purpose. Every form post would contain a hidden parameter containing a signed UUID. Its signature is stored in the session. When the user submits the form, it includes the uuid, the signature and the other form inputs. The validation passes if the signatures match (session.sign=uuid.sign). An attacker would not be able to generate the correct signature, thus protecting the application from a CSRF attack</li>
    <li>
      <p />
      <strong>Add unique tokens to HTTP requests.</strong>&amp;nbsp;Add code that sends the generated unique tokens in HTTP requests to the pages that link to sensitive operations. Adding the authenticity token is trivial: For every form, add @authenticityToken() inside the form elements. For example:<pre>@import _root_.views.html.authtoken.authenticityToken

&lt;form action="@routes.Application.process()" method="post" /&gt;
   @authenticityToken()
   Please input your name
   &lt;input name="name" /&gt;&lt;input type="submit" /&gt;
&lt;/form&gt;</pre></li>
    <li>
      <p />
      <strong>Add token validation code.</strong>&amp;nbsp;Add code to the pages that carry out sensitive operations to check if the tokens sent in HTTP requests are valid or not. To validate the token, use the @AuthenticityToken Play validator, as follows:<pre>import authtoken.validator.AuthenticityToken;<br /><br />public class FormData {<br /><br />    @AuthenticityToken<br />    public String authtoken;<br /><br />    public String name;<br />}<br /><br />public static Result process() {<br /><br />    Form<formdata> form = form(FormData.class).bindFromRequest();<br /><br />    if (form.hasErrors()) {<br />        return badRequest("authenticity validation FAILED");<br />    } else {<br />        return ok("authenticity validation PASSED");<br />    }<br />}</formdata></pre></li>
  </ol>
  <p />
  <ol>
  </ol>
  <h1>Additional Resources</h1>
  <ul>
    <li>For information about the OWASP CSRFGuard project, please see&amp;nbsp;<a href="https://www.owasp.org/index.php/Category:OWASP_CSRFGuard_Project">https://www.owasp.org/index.php/Category:OWASP_CSRFGuard_Project</a></li>
  </ul>
  <div>
    <h1 style="margin: 0px; padding: 10px 0px 0px; font-size: 17px; font-family: 'Segoe UI', 'Helvetica Neue', Helvetica, Arial, sans-serif; background-color: rgb(255, 255, 255);">Session Management Guidelines</h1>
    <ul style="margin: 10px 0px 10px 25px; padding: 0px 0px 0px 30px; font-family: 'Segoe UI', 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: small; background-color: rgb(255, 255, 255);">
      <li style="margin: 0px; padding: 0px;">
        <b style="margin: 0px; padding: 0px;">
          <a href="13ad7fa3-199e-4957-9e4f-39bd931c9f1d" target="_blank" style="margin: 0px; padding: 0px; color: rgb(0, 0, 0);">Protect Session IDs</a>
        </b>
      </li>
      <li style="margin: 0px; padding: 0px;">
        <b style="margin: 0px; padding: 0px;">
          <a href="5d296e90-a27c-424a-bfe1-5576490b50c2" target="_blank" style="margin: 0px; padding: 0px; color: rgb(0, 0, 0);">Protect Session Cookies</a>
        </b>
      </li>
      <li style="margin: 0px; padding: 0px;">
        <b style="margin: 0px; padding: 0px;">
          <a href="f4218f89-d394-4162-8108-faef064f0f65" target="_blank" style="margin: 0px; padding: 0px; color: rgb(0, 0, 0);">Set the Domain and Path Values of Session Cookies</a>
        </b>
      </li>
      <li style="margin: 0px; padding: 0px;">
        <b style="margin: 0px; padding: 0px;">
          <a href="0c4222a4-6028-4191-8dcb-761bbb4d2661" target="_blank" style="margin: 0px; padding: 0px; color: rgb(0, 0, 0);">Set the Secure and HTTPOnly Flags on All Sensitive Cookies</a>
        </b>
      </li>
      <li style="margin: 0px; padding: 0px;">
        <b style="margin: 0px; padding: 0px;">
          <a href="b8e65bce-05bb-40b0-bc5b-ea6fe1e3ce96" target="_blank" style="margin: 0px; padding: 0px; color: rgb(0, 0, 0);">Change Session IDs During Authentication</a>
        </b>
      </li>
      <li style="margin: 0px; padding: 0px;">
        <b style="margin: 0px; padding: 0px;">
          <a href="05a2cfa6-d015-446b-8c25-3cb13f10d396" target="_blank" style="margin: 0px; padding: 0px; color: rgb(0, 0, 0);">Invalidate Sessions when Users Log Out</a>
        </b>
      </li>
      <li style="margin: 0px; padding: 0px;">
        <b style="margin: 0px; padding: 0px;">
          <a href="6ac43864-2644-4f33-bfb2-1366c5c3cb58" target="_blank" style="margin: 0px; padding: 0px; color: rgb(0, 0, 0);">Make Inactive Sessions Time-out</a>
        </b>
      </li>
      <li style="margin: 0px; padding: 0px;">
        <b style="margin: 0px; padding: 0px;">
          <a href="19f2779c-14ec-43fb-8e8d-4505cb0801c9" target="_blank" style="margin: 0px; padding: 0px; color: rgb(0, 0, 0);">Include Unique Tokens in HTTP Requests</a>
        </b>
      </li>
      <li style="margin: 0px; padding: 0px;">
        <b style="margin: 0px; padding: 0px;">
          <a href="7889a5ad-4e61-41da-97da-d40337050e17" target="_blank" style="margin: 0px; padding: 0px; color: rgb(0, 0, 0);">Do Not Make Security Decisions Based on Client-Accessible Parameters</a>
        </b>
      </li>
    </ul>
    <h1 style="margin: 0px; padding: 10px 0px 0px; font-size: 17px; font-family: 'Segoe UI', 'Helvetica Neue', Helvetica, Arial, sans-serif; background-color: rgb(255, 255, 255);">Session Management Checklists</h1>
    <ul style="margin: 10px 0px 10px 25px; padding: 0px 0px 0px 30px; font-family: 'Segoe UI', 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: small; background-color: rgb(255, 255, 255);">
      <li style="margin: 0px; padding: 0px;">
        <b style="margin: 0px; padding: 0px;">
          <a href="9dfbcbed-d897-4df4-b212-9d80fb26cbdf" target="_blank" style="margin: 0px; padding: 0px; color: rgb(0, 0, 0);">Session IDs Are Protected</a>
        </b>
      </li>
      <li style="margin: 0px; padding: 0px;">
        <b style="margin: 0px; padding: 0px;">
          <a href="fe0a7400-2140-4e9e-bcc7-f185acce6974" target="_blank" style="margin: 0px; padding: 0px; color: rgb(0, 0, 0);">Session Cookies are Protected</a>
        </b>
      </li>
      <li style="margin: 0px; padding: 0px;">
        <b style="margin: 0px; padding: 0px;">
          <a href="932cd357-dfd4-4f95-949b-e407b5299748" target="_blank" style="margin: 0px; padding: 0px; color: rgb(0, 0, 0);">The Domain and Path Values of Session Cookies Are Strict</a>
        </b>
      </li>
      <li style="margin: 0px; padding: 0px;">
        <b style="margin: 0px; padding: 0px;">
          <a href="0679ade9-860f-42e0-b811-2a3434410a76" target="_blank" style="margin: 0px; padding: 0px; color: rgb(0, 0, 0);">The Secure and HTTPOnly Flags Are Set on All Sensitive Cookies</a>
        </b>
      </li>
      <li style="margin: 0px; padding: 0px;">
        <b style="margin: 0px; padding: 0px;">
          <a href="3328e0df-abe9-4339-9eeb-fae6eb54042e" target="_blank" style="margin: 0px; padding: 0px; color: rgb(0, 0, 0);">Session IDs Are Changed During Authentication</a>
        </b>
      </li>
      <li style="margin: 0px; padding: 0px;">
        <b style="margin: 0px; padding: 0px;">
          <a href="636b0c98-34d0-4aed-bf06-35f80a6e5551" target="_blank" style="margin: 0px; padding: 0px; color: rgb(0, 0, 0);">Sessions Are Invalidated When Users Log Out</a>
        </b>
      </li>
      <li style="margin: 0px; padding: 0px;">
        <b style="margin: 0px; padding: 0px;">
          <a href="22c6bd72-94a7-4b86-9c9b-60d921fbd266" target="_blank" style="margin: 0px; padding: 0px; color: rgb(0, 0, 0);">Inactive Sessions Time-out</a>
        </b>
      </li>
      <li style="margin: 0px; padding: 0px;">
        <b style="margin: 0px; padding: 0px;">
          <a href="178b26f6-689b-4a0e-a117-eadf1af3404c" target="_blank" style="margin: 0px; padding: 0px; color: rgb(0, 0, 0);">Unique Tokens Are Included in HTTP Requests</a>
        </b>
      </li>
    </ul>
  </div>]]></Data>
  </Content>
</TeamMentor_Article>