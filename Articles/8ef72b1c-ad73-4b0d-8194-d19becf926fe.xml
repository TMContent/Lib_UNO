<?xml version="1.0"?>
<TeamMentor_Article Metadata_Hash="0" Content_Hash="0">
  <Metadata>
    <Id>8ef72b1c-ad73-4b0d-8194-d19becf926fe</Id>
    <Id_History>00c12016-5b40-405d-8dd8-9969b30604ef,</Id_History>
    <Library_Id>d9c2b53f-5b05-4152-be72-e79d72854707</Library_Id>
    <Title>XPath-XQuery Attack</Title>
    <Category>Input and Data Validation</Category>
    <Phase>Implementation</Phase>
    <Technology>Any</Technology>
    <Type>Attack</Type>
    <DirectLink>XPath-XQuery Attack</DirectLink>
    <Author />
    <Priority />
    <Status />
  </Metadata>
  <Content Sanitized="false" DataType="html">
    <Data><![CDATA[<h1>Applies To</h1>
  <p>Any application that can manipulate XML documents through XPath/XQuery</p>
  <h1>Description</h1>
  <p>An XPath/XQuery attack exploits input validation vulnerabilities to run arbitrary commands in XML databases. This attack works in much the same way as a SQL injection attack, but with an XML target instead of a SQL target. An Xpath/XQuery attack can occur when your application uses unvalidated user input to construct an Xpath/XQuery statement to access XML tables. This allows an attacker to execute arbitrary Xpath/XQuery statements on an XML database. This attack is often more damaging than a SQL injection attack, as permissions are not enforced and the attacker’s query can access every part of the XML document. With an Xpath/XQuery attack, it is possible to retrieve, manipulate, and destroy any data stored in the XML document.</p>
  <h1>Impact</h1>
  <ul>
    <li>
      <strong>Confidentiality:</strong>&amp;nbsp;Since XML generally holds sensitive data, loss of confidentiality is a frequent problem with XPath/XQuery injection vulnerabilities.</li>
    <li>
      <strong>Authentication:</strong>&amp;nbsp;If poor XPath/XQuery commands are used to check user names and passwords, it may be possible to connect to a system as another user with no previous knowledge of the password.</li>
    <li>
      <strong>Authorization:</strong>&amp;nbsp;If authorization information is held in an XML document, it may be possible to change this information through the successful exploitation of an XPath/XQuery injection vulnerability.</li>
    <li>
      <strong>Integrity:</strong>&amp;nbsp;Just as it may be possible to read sensitive information, it is also possible to make changes or even delete this information with an XPath/XQuery injection attack.</li>
  </ul>
  <h1>Vulnerabilities</h1>
  <ul>
    <li>Weak input validation.</li>
    <li>Generating XPath expressions by dynamically concatenating strings with user supplied data.</li>
    <li>Failure to escape single quotes, double quotes, and other potentially dangerous characters.</li>
  </ul>
  <h1>Countermeasures</h1>
  <ul>
    <li>
      <strong>Constrain input.</strong>&amp;nbsp;Use vigorous whitelist-style checking on any user input that may be used as part of an XQuery command. This will also help prevent meta characters from being added to your stored data set which will be used again.</li>
    <li>
      <strong>Use parameterized and pre-compiled XPath expressions in your XQuery instead of concatenating strings with user input.</strong>&amp;nbsp;Parameterized Xpath statements will accept characters that have special meaning to Xpath (like single quote) without problems because they are strongly typed.</li>
    <li>
      <strong>Use escaping routines.</strong>&amp;nbsp;If you cannot use parameters and must generate XPath expressions dynamically, use escaping routines to handle special characters that have meaning to the database.</li>
    <li>
      <strong>Do not echo XQuery errors.</strong>&amp;nbsp;Catch any exceptions on the server and return generic error messages to the client.</li>
  </ul>
  <h1>Example</h1>
  <p>Consider the following XML file, being used by an application to log users into the application</p>
  <pre>&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt; &lt;users&gt;&lt;user&gt;&lt;username&gt;admin&lt;/username&gt;&lt;password&gt;8af2&amp;&lt;/password&gt; &lt;account&gt;admin&lt;/account&gt; &lt;/user&gt; &lt;user&gt; &lt;username&gt;user1&lt;/username&gt; &lt;password&gt;password&lt;/password&gt; &lt;account&gt;guest&lt;/account&gt; &lt;/user&gt; &lt;user&gt; &lt;username&gt;user2&lt;/username&gt; &lt;password&gt;1234&lt;/password&gt; &lt;account&gt;guest&lt;/account&gt; &lt;/user&gt; &lt;/users&gt;</pre>
  <p>A developer could use the following Xpath command to return all the users with the username input by the user:<br /></p>
  <pre>‘user’string and password ‘password’string(//user[username/text()='user' and password/text()='password']/account/text())</pre>
  <p>However, without proper input validation, the attacker could easily input a logic statement to manipulate the output of the query. An attacker could provide the following string to the Xpath statement above.</p>
  <pre>Username: user1 Password: ' or '1' = '1</pre>
  <p>This will change the Xpath statement to look like this:</p>
  <pre>string(//user[username/text()='user1' and password/text()='' or '1' = '1']/account/text())</pre>
  <p>The password portion of the query will always resolve to true, which means that the application will authenticate the attacker as user1 even though no password was provided.</p>
  <p>A good way to fix this example is to use a parameterized query. The idea here is to create a precompiled query that gets values from parameters instead of dynamically creating an XPath expression by concatenation at run time. Let $username and $password be string variables that hold the users input. Then construct a query in the following way:</p>
  <pre>"//user[user[username/text()=$username and password/text()=$password]"</pre>
  <h1>Additional Resources</h1>
  <ul>
    <li>
      <a href="http://www.tkachenko.com/blog/archives/000385.html">http://www.tkachenko.com/blog/archives/000385.html</a>
    </li>
    <li>
      <a href="http://www.owasp.org/index.php/XML_Injection">http://www.owasp.org/index.php/XML_Injection</a>
    </li>
    <li>
      <a href="http://palisade.plynt.com/issues/2005Jul/xpath-injection/index.php">http://palisade.plynt.com/issues/2005Jul/xpath-injection/index.php</a>
    </li>
  </ul>
  <div>
    <h1 style="margin: 0px; padding: 10px 0px 0px; font-size: 17px; color: rgb(17, 17, 17); font-family: 'Segoe UI', 'Helvetica Neue', Helvetica, Arial, sans-serif;">Related Items</h1>
    <ul style="margin: 10px 0px 10px 25px; padding: 0px 0px 0px 30px; color: rgb(17, 17, 17); font-family: 'Segoe UI', 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: small;">
      <li style="margin: 0px; padding: 0px;">
        <a href="3b45dd83-7d7b-4e2e-a5ca-83a9a3eaec56" target="_blank" style="margin: 0px; padding: 0px; color: rgb(51, 51, 153); font-weight: bold;">Attack: Cross Site Scripting Attack</a>
      </li>
      <li style="margin: 0px; padding: 0px;">
        <a href="7088b485-e0de-4649-8c0e-1a9c40619436" target="_blank" style="margin: 0px; padding: 0px; color: rgb(51, 51, 153); font-weight: bold;">Attack:&amp;nbsp;Command Injection Attack</a>
      </li>
      <li style="margin: 0px; padding: 0px;">
        <a href="86060870-16cd-4115-a5cf-ba47e61f9f0b" target="_blank" style="margin: 0px; padding: 0px; color: rgb(51, 51, 153); font-weight: bold;">Attack: XML Injection Attack</a>
      </li>
      <li style="margin: 0px; padding: 0px;">
        <a href="97d61072-14e2-48dd-a1bf-ec149efbcb54" target="_blank" style="margin: 0px; padding: 0px; color: rgb(51, 51, 153); font-weight: bold;">Guideline: Do Not Rely on Client-Side Validation</a>
      </li>
      <li style="margin: 0px; padding: 0px;">
        <a href="3b46e08b-1e8a-4dbf-b7bc-39a13c8afcbc" target="_blank" style="margin: 0px; padding: 0px; color: rgb(51, 51, 153); font-weight: bold;">Guideline: Encode All Output Data</a>
      </li>
      <li style="margin: 0px; padding: 0px;">
        <a href="b6795407-d01e-44ec-8aed-a440d388902b" target="_blank" style="margin: 0px; padding: 0px; color: rgb(51, 51, 153); font-weight: bold;">Guideline: Validate Input for Length, Range, Format, and Type</a>
      </li>
      <li style="margin: 0px; padding: 0px;">
        <a href="af528b9a-af5f-49b8-a314-4578c0b31273" target="_blank" style="margin: 0px; padding: 0px; color: rgb(51, 51, 153); font-weight: bold;">Guideline: Validate Input from All Sources</a>
      </li>
    </ul>
  </div>
  <ul>
  </ul>]]></Data>
  </Content>
</TeamMentor_Article>